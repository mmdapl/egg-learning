<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>内置对象 | 薛定谔的Egg.js</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/egg-learning/assets/egg_learning_logo.png">
    <meta name="description" content="官方文档出发、结合使用体验，不一样的笔记文档">
    <meta name="author" content="Rong姐姐好可爱,Bilibili、Github、公众号都是这样啦">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="Rong姐姐好可爱">
    <link rel="preload" href="/egg-learning/assets/css/0.styles.60aff8c3.css" as="style"><link rel="preload" href="/egg-learning/assets/js/app.832bcef2.js" as="script"><link rel="preload" href="/egg-learning/assets/js/2.37616b7d.js" as="script"><link rel="preload" href="/egg-learning/assets/js/11.9bf31c6c.js" as="script"><link rel="prefetch" href="/egg-learning/assets/js/10.5e615cbe.js"><link rel="prefetch" href="/egg-learning/assets/js/12.7ac13721.js"><link rel="prefetch" href="/egg-learning/assets/js/13.ed54cc91.js"><link rel="prefetch" href="/egg-learning/assets/js/14.211de7bf.js"><link rel="prefetch" href="/egg-learning/assets/js/15.59cbab71.js"><link rel="prefetch" href="/egg-learning/assets/js/16.a98989fb.js"><link rel="prefetch" href="/egg-learning/assets/js/17.e180ff8a.js"><link rel="prefetch" href="/egg-learning/assets/js/18.57eafdc5.js"><link rel="prefetch" href="/egg-learning/assets/js/19.1f9b8c6b.js"><link rel="prefetch" href="/egg-learning/assets/js/20.92d0ca54.js"><link rel="prefetch" href="/egg-learning/assets/js/21.a904c12f.js"><link rel="prefetch" href="/egg-learning/assets/js/22.79ac6ee2.js"><link rel="prefetch" href="/egg-learning/assets/js/23.198d3f8b.js"><link rel="prefetch" href="/egg-learning/assets/js/24.204b7af2.js"><link rel="prefetch" href="/egg-learning/assets/js/25.7ee29836.js"><link rel="prefetch" href="/egg-learning/assets/js/3.c2034b81.js"><link rel="prefetch" href="/egg-learning/assets/js/4.5df22fa4.js"><link rel="prefetch" href="/egg-learning/assets/js/5.fdb6cfce.js"><link rel="prefetch" href="/egg-learning/assets/js/6.9f2e4ded.js"><link rel="prefetch" href="/egg-learning/assets/js/7.62f90180.js"><link rel="prefetch" href="/egg-learning/assets/js/8.72441dce.js"><link rel="prefetch" href="/egg-learning/assets/js/9.58d4e40f.js">
    <link rel="stylesheet" href="/egg-learning/assets/css/0.styles.60aff8c3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/egg-learning/" class="router-link-active no-logo home-link"><!----> <span class="site-name">薛定谔的Egg.js</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item ant-menu-item-selected"><a href="/egg-learning/official/" class="router-link-active">
          基础
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/egg-learning/egg-core/">
          进阶
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/egg-learning/egg-plugin/">
          插件应用
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/egg-learning/practice/">
          最佳实践
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          开源插件
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          我的项目
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <a href="https://github.com/mmdapl" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="ads"><div id="ads_2"><div class="ant-carousel"><div class="slick-slider slick-initialized"><div class="slick-list"><div class="slick-track"></div></div></div></div></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div> <ul class="sidebar-links"><li><a href="/egg-learning/official/" aria-current="page" title="开始阅读" class="sidebar-link">开始阅读</a></li><li><a href="/egg-learning/official/version_record.html" title="更新日志" class="sidebar-link">更新日志</a></li><li><a href="/egg-learning/official/introduce.html" title="简单介绍" class="sidebar-link">简单介绍</a></li><li><a href="/egg-learning/official/quick_start.html" title="快速入门" class="sidebar-link">快速入门</a></li><li><a href="/egg-learning/official/catalog.html" title="目录结构" class="sidebar-link">目录结构</a></li><li><a href="/egg-learning/official/frame_object.html" aria-current="page" title="内置对象" class="active sidebar-link">内置对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#application对象" title="Application对象" class="sidebar-link">Application对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#支持事件" title="支持事件" class="sidebar-link">支持事件</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#context对象" title="Context对象" class="sidebar-link">Context对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#获取方式-2" title="获取方式" class="sidebar-link">获取方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#request和response对象" title="Request和Response对象" class="sidebar-link">Request和Response对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#获取方式-3" title="获取方式" class="sidebar-link">获取方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#controller对象" title="Controller对象" class="sidebar-link">Controller对象</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#service对象" title="Service对象" class="sidebar-link">Service对象</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#helper对象" title="Helper对象" class="sidebar-link">Helper对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#方法自定义" title="方法自定义" class="sidebar-link">方法自定义</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#config对象" title="Config对象" class="sidebar-link">Config对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#获取方式-5" title="获取方式" class="sidebar-link">获取方式</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#logger对象" title="Logger对象" class="sidebar-link">Logger对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#app-logger" title="App Logger" class="sidebar-link">App Logger</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#app-corelogger" title="App CoreLogger" class="sidebar-link">App CoreLogger</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#context-logger" title="Context Logger" class="sidebar-link">Context Logger</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#context-corelogger" title="Context CoreLogger" class="sidebar-link">Context CoreLogger</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#controller-logger-service-logger" title="Controller Logger &amp; Service Logger" class="sidebar-link">Controller Logger &amp; Service Logger</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-learning/official/frame_object.html#定时任务" title="定时任务" class="sidebar-link">定时任务</a></li></ul></li><li><a href="/egg-learning/official/running_env.html" title="运行环境（Env）" class="sidebar-link">运行环境（Env）</a></li><li><a href="/egg-learning/official/middleware.html" title="中间件（Middleware）" class="sidebar-link">中间件（Middleware）</a></li><li><a href="/egg-learning/official/router.html" title="路由（Router）" class="sidebar-link">路由（Router）</a></li><li><a href="/egg-learning/official/controller.html" title="控制器（Controller）" class="sidebar-link">控制器（Controller）</a></li><li><a href="/egg-learning/official/service.html" title="服务（Service）" class="sidebar-link">服务（Service）</a></li><li><a href="/egg-learning/official/schedule.html" title="定时任务（Schedule）" class="sidebar-link">定时任务（Schedule）</a></li><li><a href="/egg-learning/official/frame_extend.html" title="框架扩展（Extend）" class="sidebar-link">框架扩展（Extend）</a></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="内置对象"><a href="#内置对象" class="header-anchor">#</a> 内置对象</h1> <p>在Egg框架中，包含了很多内置的基础对象，常用到的有：</p> <ul><li>Application</li> <li>Context</li> <li>Request</li> <li>Response</li> <li>Controller</li> <li>Service</li> <li>Helper</li> <li>Config</li> <li>Logger</li></ul> <p>其中，从Koa框架中继承的对象有：</p> <ul><li>Application</li> <li>Context</li> <li>Request</li> <li>Response</li></ul> <p>下面将会以官方文档为基础，加上自己的使用、学习体验进行一一整理说明。</p> <h2 id="application对象"><a href="#application对象" class="header-anchor">#</a> Application对象</h2> <p>Application 是全局应用对象，在一个应用中，只会实例化一个，它继承自 Koa.Application，在上面我们可以挂载一些全局的方法和对象。</p> <h3 id="支持事件"><a href="#支持事件" class="header-anchor">#</a> 支持事件</h3> <p>在项目入口通过app.js来启动项目，在项目运行时，会在Application对象实例上触发一些事件，应用开发者或者插件开发者可以监听这些事件做一些操作，一般在app.js中进行监听</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token comment">// app.js</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'server'</span><span class="token punctuation">,</span> <span class="token parameter">server</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// websocket</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 监听错误信息</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 接收request对象日志</span>

  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 报告项目启动事件，其中ctx.start_time可以配置</span>
    <span class="token keyword">const</span> used <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ctx<span class="token punctuation">.</span>start_time<span class="token punctuation">;</span>
    <span class="token comment">// 日志记录</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><ul><li><code>server</code>: 该事件一个 worker 进程只会触发一次，在 HTTP 服务完成启动后，会将 HTTP server 通过这个事件暴露出来给开发者。</li> <li><code>error</code>: 运行时有任何的异常被 onerror 插件捕获后，都会触发 error 事件，将错误对象和关联的上下文（如果有）暴露给开发者，可以进行自定义的日志记录上报等处理。</li> <li><code>request 和 response</code>: 应用收到请求和响应请求时，分别会触发 request 和 response 事件，并将当前请求上下文暴露出来，开发者可以监听这两个事件来进行日志记录。</li></ul> <h4 id="获取方式"><a href="#获取方式" class="header-anchor">#</a> 获取方式</h4> <p>Application 对象几乎可以在编写应用时的任何一个地方获取到;</p> <ul><li>在app.js中使用</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 绑定缓存redis</span>
  app<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>框架 Loader 加载的文件（Controller，Service，Schedule 等），都可以 export 一个函数，这个函数会被 Loader 调用，并使用 app 作为参数</strong></p> <ul><li>Controller中使用</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/user.js</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查询用户</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">,</span>app<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token operator">=</span>ctx<span class="token punctuation">.</span>query
      ctx<span class="token punctuation">.</span>body<span class="token operator">=</span>app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>和 Koa 一样，在 Context 对象上，可以通过 ctx.app 访问到 Application 对象。上面的UserController文件也可以改为：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/user.js</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">,</span>app<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token operator">=</span>ctx<span class="token punctuation">.</span>query
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>在继承于 Controller, Service 基类的实例中，可以通过 this.app 访问到 Application 对象。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/service/user.js</span>
<span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token parameter">uid</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">,</span>app<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>综上，访问application对象实例可以通过ctx.app或者this.app或者app参数即可。</p> <h2 id="context对象"><a href="#context对象" class="header-anchor">#</a> Context对象</h2> <p>Context 是一个请求级别的对象，继承自 Koa.Context。在每一次收到用户请求时，框架会实例化一个 Context 对象，这个对象封装了这次用户请求的信息，并提供了许多便捷的方法来获取请求参数或者设置响应信息。<strong>框架会将所有的 Service 挂载到 Context 实例上.</strong> 如果你考虑封装一个插件，非常建议将一些方法和对象挂载到ctx对象上，这样在调用时就非常方便，就我个人而言，<strong>ctx的使用是明显高于app的；</strong></p> <h3 id="获取方式-2"><a href="#获取方式-2" class="header-anchor">#</a> 获取方式</h3> <ul><li>中间件里获取</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'use strict'</span>

<span class="token comment">// 中间件</span>
<span class="token keyword">async</span> <span class="token keyword">function</span>  <span class="token function">middleware</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 日志打印参数</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>这里跟Koa框架是非常类似的，如果没有将ctx作为参数，context对象也是可以从this对象中获取；</p> <ul><li>支持Controller和Service里面获取</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 直接在this对象中拿到</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span>

</code></pre></div><ul><li>创建匿名Context实例</li></ul> <blockquote><p>在有些非用户请求的场景下我们需要访问 service / model 等 Context 实例上的对象，可以通过 Application.createAnonymousContext() 方法创建一个匿名 Context 实例</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 例如：app.js中</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token parameter">app</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">beforeStart</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> ctx<span class="token operator">=</span>app<span class="token punctuation">.</span><span class="token function">createAnonymousContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment">// 使用ctx对象</span>
        <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意，createAnonymousContext()函数是在application对象提供</p> <ul><li>定时任务中使用</li></ul> <p>在定时任务中的每一个 task 都接受一个 Context 实例作为参数，非常方便的帮助执行一些定时的业务逻辑</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/schedule/refresh.js</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">task</span><span class="token operator">=</span><span class="token keyword">async</span> <span class="token parameter">ctx</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token comment">// 使用ctx对象</span>
<span class="token punctuation">}</span>

</code></pre></div><h2 id="request和response对象"><a href="#request和response对象" class="header-anchor">#</a> Request和Response对象</h2> <p>这两个对象在项目中使用频率非常高，而且两者用法类似。</p> <ul><li><p><strong>Request 是一个请求级别的对象</strong> ，继承自 Koa.Request。封装了 Node.js 原生的 HTTP Request 对象，提供了一系列辅助方法获取 HTTP 请求常用参数。</p></li> <li><p><strong>Response 是一个请求级别的对象</strong>，继承自 Koa.Response。封装了 Node.js 原生的 HTTP Response 对象，提供了一系列辅助方法设置 HTTP 响应。</p></li></ul> <h3 id="获取方式-3"><a href="#获取方式-3" class="header-anchor">#</a> 获取方式</h3> <p>可以在 Context 的实例上获取到当前请求的 Request(ctx.request) 和 Response(ctx.response) 实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token comment">// app/controller/user.js</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// request对象获取参数</span>
    
    <span class="token comment">// 获取query参数  get请求</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span> <span class="token operator">=</span>  ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">;</span>

    <span class="token comment">// 获取表单数据  post请求</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>user_name<span class="token punctuation">}</span><span class="token operator">=</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body

    <span class="token comment">// response对象设置响应</span>
    ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>body <span class="token operator">=</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



</code></pre></div><p>值得注意的时，Koa框架会在Context对象上面代理一部分Request和Response上方法和属性，因此：</p> <ul><li><p><code>ctx.request.query</code>和<code>ctx.query</code>在使用上是等价的。</p></li> <li><p><code>ctx.response.body</code>和<code>ctx.body</code>在使用上是等价的。</p></li></ul> <h2 id="controller对象"><a href="#controller对象" class="header-anchor">#</a> Controller对象</h2> <p>项目结构中的controller是继承框架中的Controller基类实现的，当继承该对象，也就继承了对应的属性：</p> <ul><li><code>ctx</code>   当前请求的 Context 实例。</li> <li><code>app</code>   应用的 Application 实例。</li> <li><code>config</code>  应用的配置。</li> <li><code>service</code>   应用所有的 service。</li> <li><code>logger</code>   为当前 controller 封装的 logger 对象。</li></ul> <p>获取框架提供的Controller对象的方案：</p> <ul><li>方案一：从 egg模块上获取（推荐）</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/user.js</span>

<span class="token string">'use strict'</span>

<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token comment">// 这里可以用解构  const {Controller} =require('egg')</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">// 构造函数</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 实际方法定义</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController<span class="token punctuation">;</span>

</code></pre></div><ul><li>方案二：从 app 实例上获取</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/user.js</span>
<span class="token string">'use strict'</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">app<span class="token punctuation">.</span>Controller</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构造函数</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 实际方法定义</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="service对象"><a href="#service对象" class="header-anchor">#</a> Service对象</h2> <p>和Controller对象一样，框架也提供了Service对象，项目结构中的Service是继承框架中的Service基类实现的，当继承该对象，也就继承了对应的属性,两者的共性非常多，用法基本一致；</p> <p>获取框架提供的Service对象的方案：</p> <ul><li>方案一：从 egg模块上获取（推荐）</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/service/user.js</span>

<span class="token string">'use strict'</span>

<span class="token keyword">const</span> Service <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Service<span class="token punctuation">;</span>
<span class="token comment">// 这里可以用解构  const {Controller} =require('egg')</span>
<span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  <span class="token comment">// 构造函数</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token operator">...</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 实际方法定义</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserService<span class="token punctuation">;</span>

</code></pre></div><ul><li>方案二：从 app 实例上获取</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/service/user.js</span>
<span class="token string">'use strict'</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token keyword">extends</span> <span class="token class-name">app<span class="token punctuation">.</span>Service</span> <span class="token punctuation">{</span>
    <span class="token comment">// 构造函数</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token operator">...</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 实际方法定义</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="helper对象"><a href="#helper对象" class="header-anchor">#</a> Helper对象</h2> <p>Helper 用来提供一些实用的 utility 函数。作用在于我们可以将一些常用的动作抽离在 helper.js 里面成为一个独立的函数，这样可以用 JavaScript 来写复杂的逻辑，避免逻辑分散各处，同时可以更好的编写测试用例。不通的处理；</p> <p><strong>Helper 自身是一个类，有和 Controller 基类一样的属性，它也会在每次请求时进行实例化，因此 Helper 上的所有函数也能获取到当前请求相关的ctx上下文信息</strong></p> <h4 id="获取方式-4"><a href="#获取方式-4" class="header-anchor">#</a> 获取方式</h4> <p>可以在 Context 的实例上获取到当前请求的 Helper(ctx.helper) 对象实例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/user.js</span>
<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> id <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> app<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">formatUser</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="方法自定义"><a href="#方法自定义" class="header-anchor">#</a> 方法自定义</h3> <p>在框架的设计中，helper.js文件的功能主要提供一些常用工具函数的封装，所以除了系统自带的，更多的使用场景是进行方法自定义，比如：常用正则校验、长度检测、排序处理等；</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/extend/helper.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 封装统一返回</span>
  <span class="token function">returnFormat</span><span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span>message<span class="token punctuation">,</span>result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>code<span class="token punctuation">,</span>message<span class="token punctuation">,</span>result<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>另外，像<code>ctx.helper.escape()</code>也是非常常用的，用于防止xss攻击，对标签进行序列化；</p> <h2 id="config对象"><a href="#config对象" class="header-anchor">#</a> Config对象</h2> <p>框架提供了强大且可扩展的配置功能，可以自动合并应用、插件、框架的配置，按顺序覆盖，且可以根据环境维护不同的配置。合并后的配置可直接从<code>app.config</code> 获取</p> <h3 id="获取方式-5"><a href="#获取方式-5" class="header-anchor">#</a> 获取方式</h3> <ul><li><p>app.config 从 Application 实例上获取到 config 对象</p></li> <li><p><strong>也可以在 Controller, Service, Helper 的实例上通过 this.config 获取到 config 对象</strong></p></li></ul> <p>除了框架自带的配置，其他自定义的配置，也是可以初始化到Config对象中的</p> <h2 id="logger对象"><a href="#logger对象" class="header-anchor">#</a> Logger对象</h2> <p>框架内置了功能强大的日志功能，可以非常方便的打印各种级别的日志到对应的日志文件中，每一个 logger 对象都提供了 4 个级别的方法</p> <ul><li><p><code>logger.debug()</code></p></li> <li><p><code>logger.info()</code></p></li> <li><p><code>logger.warn()</code></p></li> <li><p><code>logger.error()</code></p></li></ul> <p>Logger对象根据不同的使用场景，主要有：</p> <ul><li><h3 id="app-logger"><a href="#app-logger" class="header-anchor">#</a> App Logger</h3></li></ul> <blockquote><p>通过 <code>app.logger</code> 来获取到它，如果我们想做一些应用级别的日志记录，如记录启动阶段的一些数据信息，记录一些业务上与请求无关的信息，都可以通过 <code>App Logger</code> 来完成。</p></blockquote> <ul><li><h3 id="app-corelogger"><a href="#app-corelogger" class="header-anchor">#</a> App CoreLogger</h3></li></ul> <blockquote><p>可以通过 <code>app.coreLogger</code> 来获取到它，一般我们在开发应用时都不应该通过 <code>CoreLogger</code> 打印日志，而框架和插件则需要通过它来打印应用级别的日志，这样可以更清晰的区分应用和框架打印的日志，通过 <code>CoreLogger</code> 打印的日志会放到和 <code>Logger</code> 不同的文件中。</p></blockquote> <ul><li><h3 id="context-logger"><a href="#context-logger" class="header-anchor">#</a> Context Logger</h3></li></ul> <blockquote><p>可以通过 <code>ctx.logger</code> 从 <code>Context</code> 实例上获取到它，从访问方式上我们可以看出来，<code>Context Logger</code> 一定是与请求相关的，它打印的日志都会在前面带上一些当前请求相关的信息（如 <code>[$userId/$ip/$traceId/${cost}ms $method $url]</code>），通过这些信息，我们可以从日志快速定位请求，并串联一次请求中的所有的日志。。</p></blockquote> <ul><li><h3 id="context-corelogger"><a href="#context-corelogger" class="header-anchor">#</a> Context CoreLogger</h3></li></ul> <blockquote><p>可以通过 <code>ctx.coreLogger</code> 获取到它，和 <code>Context Logger</code> 的区别是一般只有插件和框架会通过它来记录日志。</p></blockquote> <ul><li><h3 id="controller-logger-service-logger"><a href="#controller-logger-service-logger" class="header-anchor">#</a> Controller Logger &amp; Service Logger</h3></li></ul> <blockquote><p>可以在 <code>Controller</code> 和 <code>Service</code> 实例上通过 <code>this.logger</code> 获取到它们，它们本质上就是一个 <code>Context Logger</code>，不过在打印日志的时候还会额外的加上文件路径，方便定位日志的打印位置。。</p></blockquote> <h2 id="定时任务"><a href="#定时任务" class="header-anchor">#</a> 定时任务</h2> <p>除了上面介绍的几大对象外，框架还专门提供了处理定时任务的方案——subscription</p> <p>订阅模型是一种比较常见的开发模式，譬如消息中间件的消费者或调度任务。因此提供了 Subscription 基类来规范化这个模式</p> <p>简单的定时任务:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 引用 Subscription 基类：</span>

<span class="token keyword">const</span> Subscription <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Subscription<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Schedule</span> <span class="token keyword">extends</span> <span class="token class-name">Subscription</span> <span class="token punctuation">{</span>
  <span class="token comment">// 需要实现此方法,方法里面可以调用其他封装</span>
  <span class="token keyword">async</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">1/19/2021, 11:03:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/egg-learning/official/catalog.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        目录结构
      </a></span> <span class="next"><a href="/egg-learning/official/running_env.html">
        运行环境（Env）
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/egg-learning/assets/js/app.832bcef2.js" defer></script><script src="/egg-learning/assets/js/2.37616b7d.js" defer></script><script src="/egg-learning/assets/js/11.9bf31c6c.js" defer></script>
  </body>
</html>