<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>控制器（Controller） | 薛定谔的Egg.js</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/egg-learning/assets/egg_learning_logo.png">
    <meta name="description" content="官方文档出发、结合使用体验，不一样的笔记文档">
    <meta name="author" content="Rong姐姐好可爱,Bilibili、Github、公众号都是这样啦">
    <meta name="google" content="notranslate">
    <meta name="keywords" content="Rong姐姐好可爱">
    <link rel="preload" href="/egg-learning/assets/css/0.styles.60aff8c3.css" as="style"><link rel="preload" href="/egg-learning/assets/js/app.832bcef2.js" as="script"><link rel="preload" href="/egg-learning/assets/js/2.37616b7d.js" as="script"><link rel="preload" href="/egg-learning/assets/js/9.58d4e40f.js" as="script"><link rel="prefetch" href="/egg-learning/assets/js/10.5e615cbe.js"><link rel="prefetch" href="/egg-learning/assets/js/11.9bf31c6c.js"><link rel="prefetch" href="/egg-learning/assets/js/12.7ac13721.js"><link rel="prefetch" href="/egg-learning/assets/js/13.ed54cc91.js"><link rel="prefetch" href="/egg-learning/assets/js/14.211de7bf.js"><link rel="prefetch" href="/egg-learning/assets/js/15.59cbab71.js"><link rel="prefetch" href="/egg-learning/assets/js/16.a98989fb.js"><link rel="prefetch" href="/egg-learning/assets/js/17.e180ff8a.js"><link rel="prefetch" href="/egg-learning/assets/js/18.57eafdc5.js"><link rel="prefetch" href="/egg-learning/assets/js/19.1f9b8c6b.js"><link rel="prefetch" href="/egg-learning/assets/js/20.92d0ca54.js"><link rel="prefetch" href="/egg-learning/assets/js/21.a904c12f.js"><link rel="prefetch" href="/egg-learning/assets/js/22.79ac6ee2.js"><link rel="prefetch" href="/egg-learning/assets/js/23.198d3f8b.js"><link rel="prefetch" href="/egg-learning/assets/js/24.204b7af2.js"><link rel="prefetch" href="/egg-learning/assets/js/25.7ee29836.js"><link rel="prefetch" href="/egg-learning/assets/js/3.c2034b81.js"><link rel="prefetch" href="/egg-learning/assets/js/4.5df22fa4.js"><link rel="prefetch" href="/egg-learning/assets/js/5.fdb6cfce.js"><link rel="prefetch" href="/egg-learning/assets/js/6.9f2e4ded.js"><link rel="prefetch" href="/egg-learning/assets/js/7.62f90180.js"><link rel="prefetch" href="/egg-learning/assets/js/8.72441dce.js">
    <link rel="stylesheet" href="/egg-learning/assets/css/0.styles.60aff8c3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/egg-learning/" class="router-link-active no-logo home-link"><!----> <span class="site-name">薛定谔的Egg.js</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><ul role="menu" id="nav" class="ant-menu ant-menu-horizontal ant-menu-root ant-menu-light"><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item ant-menu-item-selected"><a href="/egg-learning/official/" class="router-link-active">
          基础
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/egg-learning/egg-core/">
          进阶
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/egg-learning/egg-plugin/">
          插件应用
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-item"><a href="/egg-learning/practice/">
          最佳实践
        </a></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          开源插件
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="display:none;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>
          我的项目
        </span><i class="ant-menu-submenu-arrow"></i></div></li><li role="menuitem" class="ant-menu-submenu ant-menu-submenu-horizontal ant-menu-overflowed-submenu" style="visibility:hidden;position:absolute;"><div aria-haspopup="true" class="ant-menu-submenu-title"><span>···</span><i class="ant-menu-submenu-arrow"></i></div></li></ul> <a href="https://github.com/mmdapl" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><div><div class="ads"><div id="ads_2"><div class="ant-carousel"><div class="slick-slider slick-initialized"><div class="slick-list"><div class="slick-track"></div></div></div></div></div></div> <div role="separator" id="reset-margin" class="ant-divider ant-divider-horizontal ant-divider-dashed"></div></div> <ul class="sidebar-links"><li><a href="/egg-learning/official/" aria-current="page" title="开始阅读" class="sidebar-link">开始阅读</a></li><li><a href="/egg-learning/official/version_record.html" title="更新日志" class="sidebar-link">更新日志</a></li><li><a href="/egg-learning/official/introduce.html" title="简单介绍" class="sidebar-link">简单介绍</a></li><li><a href="/egg-learning/official/quick_start.html" title="快速入门" class="sidebar-link">快速入门</a></li><li><a href="/egg-learning/official/catalog.html" title="目录结构" class="sidebar-link">目录结构</a></li><li><a href="/egg-learning/official/frame_object.html" title="内置对象" class="sidebar-link">内置对象</a></li><li><a href="/egg-learning/official/running_env.html" title="运行环境（Env）" class="sidebar-link">运行环境（Env）</a></li><li><a href="/egg-learning/official/middleware.html" title="中间件（Middleware）" class="sidebar-link">中间件（Middleware）</a></li><li><a href="/egg-learning/official/router.html" title="路由（Router）" class="sidebar-link">路由（Router）</a></li><li><a href="/egg-learning/official/controller.html" aria-current="page" title="控制器（Controller）" class="active sidebar-link">控制器（Controller）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#控制器-controller" title="控制器(Controller)" class="sidebar-link">控制器(Controller)</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#编写controller" title="编写Controller" class="sidebar-link">编写Controller</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#controller-类-推荐" title="Controller 类（推荐）" class="sidebar-link">Controller 类（推荐）</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#自定义-controller-基类" title="自定义 Controller 基类" class="sidebar-link">自定义 Controller 基类</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#controller-方法-不推荐使用-只是为了兼容" title="Controller 方法（不推荐使用，只是为了兼容）" class="sidebar-link">Controller 方法（不推荐使用，只是为了兼容）</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#获取-http-请求参数" title="获取 HTTP 请求参数" class="sidebar-link">获取 HTTP 请求参数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#query" title="Query" class="sidebar-link">Query</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#queries" title="Queries" class="sidebar-link">Queries</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#params" title="params" class="sidebar-link">params</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#body" title="Body" class="sidebar-link">Body</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#文件上传" title="文件上传" class="sidebar-link">文件上传</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#header" title="header" class="sidebar-link">header</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#参数校验" title="参数校验" class="sidebar-link">参数校验</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#自定义校验规则" title="自定义校验规则" class="sidebar-link">自定义校验规则</a></li></ul></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#调用-service" title="调用 Service" class="sidebar-link">调用 Service</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#发送-http-响应" title="发送 HTTP 响应" class="sidebar-link">发送 HTTP 响应</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#设置-status" title="设置 status" class="sidebar-link">设置 status</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#设置-body" title="设置 body" class="sidebar-link">设置 body</a></li><li class="sidebar-sub-header"><a href="/egg-learning/official/controller.html#渲染模板" title="渲染模板" class="sidebar-link">渲染模板</a></li></ul></li><li><a href="/egg-learning/official/service.html" title="服务（Service）" class="sidebar-link">服务（Service）</a></li><li><a href="/egg-learning/official/schedule.html" title="定时任务（Schedule）" class="sidebar-link">定时任务（Schedule）</a></li><li><a href="/egg-learning/official/frame_extend.html" title="框架扩展（Extend）" class="sidebar-link">框架扩展（Extend）</a></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="控制器"><a href="#控制器" class="header-anchor">#</a> 控制器</h1> <p>在传统的MVC架构中，C可以理解为控制器Controller，而在Egg框架中服务是在控制器的下发中分层抽离出来的，因此这里一起总结一下。</p> <h2 id="控制器-controller"><a href="#控制器-controller" class="header-anchor">#</a> 控制器(Controller)</h2> <p>Egg框架的router将用户的请求基于 method 和 URL 分发到了对应的 Controller 上，Controller负责解析用户的输入，处理后返回相应的结果。</p> <ul><li>在 RESTful 接口中，Controller 接受用户的参数，从数据库中查找内容返回给用户或者将用户的请求更新到数据库中。</li> <li>在 HTML 页面请求中，Controller 根据用户访问不同的 URL，渲染不同的模板得到 HTML 返回给用户。</li> <li>在代理服务器中，Controller 将用户的请求转发到其他服务器上，并将其他服务器的处理结果返回给用户。</li></ul> <p><strong>框架推荐 Controller 层主要对用户的请求参数进行处理（校验、转换），然后调用对应的 service 方法处理业务，得到业务结果后封装并返回</strong></p> <ul><li>获取用户通过 HTTP 传递过来的请求参数。</li> <li>校验、组装参数。</li> <li>调用 Service 进行业务处理，必要时处理转换 Service 的返回结果，让它适应用户的需求。</li> <li>通过 HTTP 将结果响应给用户。</li></ul> <h2 id="编写controller"><a href="#编写controller" class="header-anchor">#</a> 编写Controller</h2> <p>所有的 <code>Controller</code> 文件都必须放在 <code>app/controller</code> 目录下，可以支持多级目录，访问的时候可以通过目录名级联访问。<code>Controller</code> 支持多种形式进行编写，可以根据不同的项目场景和开发习惯来选择</p> <h3 id="controller-类-推荐"><a href="#controller-类-推荐" class="header-anchor">#</a> Controller 类（推荐）</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 继承基类，编写自定义Controller逻辑</span>
<span class="token comment">// app/controller/post.js</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> createRule <span class="token operator">=</span> <span class="token punctuation">{</span>
      title<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 校验参数</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>createRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 组装参数</span>
    <span class="token keyword">const</span> author <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token keyword">const</span> req <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token punctuation">{</span> author <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用 Service 进行业务处理</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> service<span class="token punctuation">.</span>post<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置响应内容和响应状态码</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> res<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> PostController<span class="token punctuation">;</span>

</code></pre></div><p>定义了一个 <code>PostController</code> 的类，类里面的每一个方法都可以作为一个 <code>Controller</code> 在 <code>Router</code> 中引用到，我们可以从 <code>app.controller</code> 根据文件名和方法名定位到它</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'createPost'</span><span class="token punctuation">,</span> <span class="token string">'/api/posts'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>post<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Controller</code> 支持多级目录，例如如果将上面的 <code>Controller</code> 代码放到 <code>app/controller/sub/post.js</code> 中，则可以在 <code>router</code> 中这样使用：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'createPost'</span><span class="token punctuation">,</span> <span class="token string">'/api/posts'</span><span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>sub<span class="token punctuation">.</span>post<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>定义的 Controller 类，会在每一个请求访问到 server 时实例化一个全新的对象，而项目中的 Controller 类继承于 egg.Controller， this对象属性有：</p> <ul><li><code>this.ctx</code>: 当前请求的上下文 <code>Context</code> 对象的实例，<strong>通过它可以拿到框架封装好的处理当前请求的各种便捷属性和方法</strong>。</li> <li><code>this.app</code>: 当前应用 <code>Application</code> 对象的实例，<strong>通过它可以拿到框架提供的全局对象和方法</strong>。</li> <li><code>this.service</code>：应用定义的 <code>Service</code>，<strong>通过它可以访问到抽象出的业务层，等价于 <code>this.ctx.service</code></strong> 。</li> <li><code>this.config</code>：应用运行时的配置项。</li> <li><code>this.logger</code>：<code>logger</code> 对象，上面有四个方法（<code>debug</code>，<code>info</code>，<code>warn</code>，<code>error</code>），分别代表打印四个不同级别的日志，使用方法和效果与 <code>context logger</code> 中介绍的一样，但是<strong>通过这个 <code>logger</code> 对象记录的日志，在日志前面会加上打印该日志的文件路径，以便快速定位日志打印位置。</strong></li></ul> <h3 id="自定义-controller-基类"><a href="#自定义-controller-基类" class="header-anchor">#</a> 自定义 Controller 基类</h3> <p>按照类的方式编写 Controller，不仅可以更好的对 Controller 层代码进行抽象（例如将一些统一的处理抽象成一些私有方法），还可以通过自定义 Controller 基类的方式封装应用中常用的方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/core/base_controller.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">BaseController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">get</span> <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">notFound</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    msg <span class="token operator">=</span> msg <span class="token operator">||</span> <span class="token string">'not found'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> BaseController<span class="token punctuation">;</span>

</code></pre></div><p>此时在编写应用的 Controller 时，可以继承 BaseController，直接使用基类上的方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//app/controller/post.js</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../core/base_controller'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span><span class="token function">listByUser</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>posts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="controller-方法-不推荐使用-只是为了兼容"><a href="#controller-方法-不推荐使用-只是为了兼容" class="header-anchor">#</a> Controller 方法（不推荐使用，只是为了兼容）</h3> <p>每一个 <code>Controller</code> 都是一个 <code>async function</code>，它的入参为请求的上下文 <code>Context</code> 对象的实例，通过它可以拿到框架封装好的各种便捷属性和方法。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/post.js</span>
exports<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> createRule <span class="token operator">=</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    content<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 校验参数</span>
  ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>createRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 组装参数</span>
  <span class="token keyword">const</span> author <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
  <span class="token keyword">const</span> req <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token punctuation">{</span> author <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用 service 进行业务处理</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>post<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置响应内容和响应状态码</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> res<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="获取-http-请求参数"><a href="#获取-http-请求参数" class="header-anchor">#</a> 获取 HTTP 请求参数</h2> <p>框架通过在 Controller 上绑定的 Context 实例，提供了许多便捷方法和属性获取用户通过 HTTP 请求发送过来的参数。</p> <h3 id="query"><a href="#query" class="header-anchor">#</a> Query</h3> <p>在 URL 中 <code>?</code> 后面的部分是一个 <code>Query String</code>，这一部分经常用于 <code>GET</code> 类型的请求中传递参数。例如: <code>GET /posts?category=egg&amp;language=node</code> 中 <code>category=egg&amp;language=node</code> 就是用户传递过来的参数。我们可以通过 <code>ctx.query</code> 拿到解析过后的这个参数体</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">listPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
    <span class="token comment">// {</span>
    <span class="token comment">//   category: 'egg',</span>
    <span class="token comment">//   language: 'node',</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>当 <code>Query String</code> 中的 <code>key</code> 重复时，<code>ctx.query</code> 只取 key 第一次出现时的值，后面再出现的都会被忽略</strong>。<code>GET /posts?category=egg&amp;category=koa</code> 通过 <code>ctx.query</code> 拿到的值是:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token comment">// 第一次出现</span>
    category<span class="token operator">:</span><span class="token string">'egg'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样处理的原因是为了保持统一性，由于通常情况下我们都不会设计让用户传递 <code>key</code> 相同的 <code>Query String</code>，所以经常会写类似下面的代码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">const</span> key <span class="token operator">=</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>key <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do something code</span>
<span class="token punctuation">}</span>

</code></pre></div><p>而如果有人故意发起请求在 <code>Query String</code> 中带上重复的 <code>key</code> 来请求时就会引发系统异常。<strong>因此框架保证了从 <code>ctx.query</code> 上获取的参数一旦存在，一定是字符串类型。</strong></p> <h3 id="queries"><a href="#queries" class="header-anchor">#</a> Queries</h3> <p>有时候系统会设计成让用户传递相同的 <code>key</code>，例如 <code>GET /posts?category=egg&amp;id=1&amp;id=2&amp;id=3</code>。针对此类情况，<strong>框架提供了 <code>ctx.queries</code> 对象，这个对象也解析了 <code>Query String</code>，但是它不会丢弃任何一个重复的数据，而是将他们都放到一个数组中</strong>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// GET /posts?category=egg&amp;id=1&amp;id=2&amp;id=3</span>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">listPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>queries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// {</span>
    <span class="token comment">//   category: [ 'egg' ],</span>
    <span class="token comment">//   id: [ '1', '2', '3' ],</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><code>ctx.queries</code> 上所有的 <code>key</code> 如果有值，也一定会是数组类型。</p> <h3 id="params"><a href="#params" class="header-anchor">#</a> params</h3> <p><code>Router</code> 上也可以申明参数，这些参数都可以通过 <code>ctx.params</code> 获取到。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app.get('/projects/:projectId/app/:appId', 'app.listApp');</span>
<span class="token comment">// GET /projects/1/app/2</span>
<span class="token keyword">class</span> <span class="token class-name">AppController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
 <span class="token keyword">async</span> <span class="token function">listApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>projectId<span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>appId<span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="body"><a href="#body" class="header-anchor">#</a> Body</h3> <p>虽然可以通过 URL 传递参数，但是还是有很多限制：</p> <ul><li><p><strong>浏览器中会对 URL 的长度有所限制</strong>，如果需要传递的参数过多就会无法传递。</p></li> <li><p>服务端经常会将访问的完整 URL 记录到日志文件中，<strong>有一些敏感数据通过 URL 传递会不安全。</strong></p></li></ul> <p>一般请求中有 <code>body</code> 的时候，客户端（浏览器）会同时发送 <code>Content-Type</code> 告诉服务端这次请求的 <code>body</code> 是什么格式的。<strong><code>Web</code> 开发中数据传递最常用的两类格式分别是 <code>JSON</code> 和 <code>Form</code>。</strong></p> <p>框架内置了 <code>bodyParser</code> 中间件来对这两类格式的请求 <code>body</code> 解析成 <code>object</code> 挂载到 <code>ctx.request.body</code> 上。<strong><code>HTTP</code> 协议中并不建议在通过 <code>GET</code>、<code>HEAD</code> 方法访问时传递 <code>body</code></strong>，所以无法在 <code>GET</code>、<code>HEAD</code> 方法中按照此方法获取到内容。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token comment">// POST /api/posts HTTP/1.1</span>
<span class="token comment">// Host: localhost:3000</span>
<span class="token comment">// Content-Type: application/json; charset=UTF-8</span>
<span class="token comment">//</span>
<span class="token comment">// {&quot;title&quot;: &quot;controller&quot;, &quot;content&quot;: &quot;what is controller&quot;}</span>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">listPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 断言比对</span>
    assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>title<span class="token punctuation">,</span> <span class="token string">'controller'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    assert<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token string">'what is controller'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p><strong>框架对 bodyParser 设置了一些默认参数，配置好之后拥有以下特性：</strong></p> <ul><li>当请求的 <code>Content-Type</code> 为 <code>application/json</code>，<code>application/json-patch+json</code>，<code>application/vnd.api+json</code> 和 <code>application/csp-report</code> 时，会按照 <code>json</code> 格式对请求 body 进行解析，并限制 <code>body</code> 最大长度为 <code>100kb</code>。</li> <li>当请求的 <code>Content-Type</code> 为 <code>application/x-www-form-urlencoded</code> 时，会按照 <code>form</code> 格式对请求 <code>body</code> 进行解析，并限制 <code>body</code> 最大长度为 <code>100kb</code>。</li> <li>如果解析成功，<code>body</code> 一定会是一个 <code>Object</code>（可能是一个数组）。</li></ul> <p>可以在 <code>config/config.default.js</code> 中覆盖框架的默认值,变更解析时允许的最大长度:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  bodyParser<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// json字符串大小限制</span>
    jsonLimit<span class="token operator">:</span> <span class="token string">'1mb'</span><span class="token punctuation">,</span>
    <span class="token comment">// 表单大小限制</span>
    formLimit<span class="token operator">:</span> <span class="token string">'1mb'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>如果用户的请求 <code>body</code> 超过了我配置的解析最大长度，会抛出一个状态码为 <code>413</code> 的异常，如果用户请求的 <code>body</code> 解析失败（错误的 <code>JSON</code>），会抛出一个状态码为 <code>400</code> 的异常。</strong></p> <p>另外特别需要注意的是：在调整 <code>bodyParser</code> 支持的 <code>body</code> 长度时，如果我们应用前面还有一层反向代理（Nginx），可能也需要调整它的配置，确保反向代理也支持同样长度的请求 <code>body</code>。</p> <p><strong>常见的错误是把 ctx.request.body 和 ctx.body 混淆，后者其实是 ctx.response.body 的简写。</strong></p> <h3 id="文件上传"><a href="#文件上传" class="header-anchor">#</a> 文件上传</h3> <p>请求 body 除了可以带参数之外，还可以发送文件。一般来说，浏览器上都是通过 <code>Multipart/form-data</code> 格式发送文件的，框架通过内置 <code>Multipart</code> 插件来支持获取用户上传的文件，提供两种方式：</p> <ul><li>File模式</li> <li>Stream模式</li></ul> <h4 id="file模式"><a href="#file模式" class="header-anchor">#</a> File模式</h4> <p>和Stream模式相比，File模式非常简单且适合新手，可以按照如下流程来：</p> <ul><li>在 config 文件中启用 file 模式：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// config/config.default.js</span>
exports<span class="token punctuation">.</span>multipart <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>文件上传/接收</li></ul> <p>关于文件的上传,File模式下有对单个文件或者多个文件上传进行支持。具体分为:<code>前端上传</code>+<code>后端接收</code></p> <p>前端上传代码示例：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/upload?_csrf={{ ctx.csrf | safe }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  title: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  file: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Upload<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>后端接收代码示例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/upload.js</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mz/fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> Controller <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> file <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'egg-multipart-test/'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理文件，比如上传到云端</span>
      result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>oss<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment">// 需要删除临时文件</span>
      <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token operator">:</span> result<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token comment">// 获取所有的字段值</span>
      requestBody<span class="token operator">:</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的是基于最简单的单个文件上传进行的代码示例，借助<code>ctx.request.files</code>数组，取0号元素完成的。而在实际的应用中，多个文件的上传的场景是非常常见的，此时也是需要借助<code>ctx.request.files</code>数组，<strong>不过需要多注意一步——数组遍历</strong></p> <p>前端多文件上传：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/upload?_csrf={{ ctx.csrf | safe }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  title: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  file1: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  file2: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Upload<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>后端多文件上传逻辑：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/upload.js</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mz/fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">extends</span> Controller <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'got %d files'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历文件</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> file <span class="token keyword">of</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'field: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'filename: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'encoding: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mime: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>mime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tmp filepath: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> result<span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 处理文件，比如上传到云端</span>
        result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>oss<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'egg-multipart-test/'</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 需要删除临时文件</span>
        <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">unlink</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="stream模式"><a href="#stream模式" class="header-anchor">#</a> Stream模式</h4> <p>如果对于 <code>Node</code> 中的 <code>Stream</code> 模式非常熟悉，可以选择<code>Stream</code>模式。在 <code>Controller</code> 中，我们可以通过 <code>ctx.getFileStream()</code> 接口能获取到上传的文件流。</p> <h5 id="上传-接受单个文件"><a href="#上传-接受单个文件" class="header-anchor">#</a> 上传 / 接受单个文件</h5> <p>前端示例：</p> <div class="language-html extra-class"><pre class="language-html"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>/upload?_csrf={{ ctx.csrf | safe }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  title: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  file: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Upload<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>后端示例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sendToWormhole <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream-wormhole'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UploaderController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">getFileStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'egg-multipart-test/'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 文件处理，上传到云存储等等</span>
    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>oss<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 必须将上传的文件流消费掉，要不然浏览器响应会卡死</span>
      <span class="token keyword">await</span> <span class="token function">sendToWormhole</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token operator">:</span> result<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token comment">// 所有表单字段都能通过 `stream.fields` 获取到</span>
      fields<span class="token operator">:</span> stream<span class="token punctuation">.</span>fields<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UploaderController<span class="token punctuation">;</span>

</code></pre></div><p><strong>另外，要通过 ctx.getFileStream 便捷的获取到用户上传的文件，需要满足两个条件：</strong></p> <ul><li>只支持上传一个文件。</li> <li><strong>上传文件必须在所有其他的 fields 后面，否则在拿到文件流时可能还获取不到 fields。</strong></li></ul> <h6 id="上传-接受多个文件"><a href="#上传-接受多个文件" class="header-anchor">#</a> 上传 / 接受多个文件</h6> <p>如果要获取同时上传的多个文件，不能通过 <code>ctx.getFileStream()</code> 来获取，只能通过下面这种方式</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> sendToWormhole <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream-wormhole'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UploaderController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> parts <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">multipart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> part<span class="token punctuation">;</span>
    <span class="token comment">// parts() 返回 promise 对象</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>part <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这是 busboy 的字段</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'field: '</span> <span class="token operator">+</span> part<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value: '</span> <span class="token operator">+</span> part<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'valueTruncated: '</span> <span class="token operator">+</span> part<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fieldnameTruncated: '</span> <span class="token operator">+</span> part<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>part<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 这时是用户没有选择文件就点击了上传(part 是 file stream，但是 part.filename 为空)</span>
          <span class="token comment">// 需要做出处理，例如给出错误提示消息</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// part 是上传的文件流</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'field: '</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'filename: '</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'encoding: '</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mime: '</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>mime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 文件处理，上传到云存储等等</span>
        <span class="token keyword">let</span> result<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>oss<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'egg-multipart-test/'</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> part<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 必须将上传的文件流消费掉，要不然浏览器响应会卡死</span>
          <span class="token keyword">await</span> <span class="token function">sendToWormhole</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'and we are done parsing the form!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UploaderController<span class="token punctuation">;</span>

</code></pre></div><p><strong>为了保证文件上传的安全，框架限制了支持的的文件格式，框架默认支持白名单</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// images</span>
<span class="token string">'.jpg'</span><span class="token punctuation">,</span> <span class="token string">'.jpeg'</span><span class="token punctuation">,</span> <span class="token comment">// image/jpeg</span>
<span class="token string">'.png'</span><span class="token punctuation">,</span> <span class="token comment">// image/png, image/x-png</span>
<span class="token string">'.gif'</span><span class="token punctuation">,</span> <span class="token comment">// image/gif</span>
<span class="token string">'.bmp'</span><span class="token punctuation">,</span> <span class="token comment">// image/bmp</span>
<span class="token string">'.wbmp'</span><span class="token punctuation">,</span> <span class="token comment">// image/vnd.wap.wbmp</span>
<span class="token string">'.webp'</span><span class="token punctuation">,</span>
<span class="token string">'.tif'</span><span class="token punctuation">,</span>
<span class="token string">'.psd'</span><span class="token punctuation">,</span>
<span class="token comment">// text</span>
<span class="token string">'.svg'</span><span class="token punctuation">,</span>
<span class="token string">'.js'</span><span class="token punctuation">,</span> <span class="token string">'.jsx'</span><span class="token punctuation">,</span>
<span class="token string">'.json'</span><span class="token punctuation">,</span>
<span class="token string">'.css'</span><span class="token punctuation">,</span> <span class="token string">'.less'</span><span class="token punctuation">,</span>
<span class="token string">'.html'</span><span class="token punctuation">,</span> <span class="token string">'.htm'</span><span class="token punctuation">,</span>
<span class="token string">'.xml'</span><span class="token punctuation">,</span>
<span class="token comment">// tar</span>
<span class="token string">'.zip'</span><span class="token punctuation">,</span>
<span class="token string">'.gz'</span><span class="token punctuation">,</span> <span class="token string">'.tgz'</span><span class="token punctuation">,</span> <span class="token string">'.gzip'</span><span class="token punctuation">,</span>
<span class="token comment">// video</span>
<span class="token string">'.mp3'</span><span class="token punctuation">,</span>
<span class="token string">'.mp4'</span><span class="token punctuation">,</span>
<span class="token string">'.avi'</span><span class="token punctuation">,</span>

</code></pre></div><p>用户可以通过在 <code>config/config.default.js</code> 中配置<strong>来新增支持的文件扩展名，或者重写整个白名单</strong></p> <ul><li>新增支持的文件扩展名</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  multipart<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 增加对 apk 扩展名的文件支持</span>
    fileExtensions<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'.apk'</span> <span class="token punctuation">]</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>覆盖整个白名单</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  multipart<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 覆盖整个白名单，只允许上传 '.png' 格式</span>
    whitelist<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'.png'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> 
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意：当重写了 <code>whitelist</code> 时，<code>fileExtensions</code> 不生效。</strong></p> <h3 id="header"><a href="#header" class="header-anchor">#</a> header</h3> <p>除了从 URL 和请求 body 上获取参数之外，还有许多参数是通过请求 header 传递的。</p> <ul><li><code>ctx.headers</code>，<code>ctx.header</code>，<code>ctx.request.headers</code>，<code>ctx.request.header</code>：这几个方法是等价的，都是获取整个 header 对象。</li> <li><code>ctx.get(name)</code>，<code>ctx.request.get(name)</code>：获取请求 header 中的一个字段的值，<strong>如果这个字段不存在，会返回空字符串</strong>。</li> <li>建议用 <code>ctx.get(name)</code> 而不是 <code>ctx.headers['name']</code>，因为<code>ctx.get(name)</code>会自动处理大小写。</li></ul> <p>由于 <code>header</code> 比较特殊，有一些是 <code>HTTP</code> 协议规定了具体含义的（例如 <code>Content-Type</code>，<code>Accept</code>），有些是反向代理设置的，已经约定俗成（<code>X-Forwarded-For</code>），框架也会对他们增加一些便捷的 <code>getter</code>, 相关api参考：https://eggjs.org/api/</p> <p><strong>特别是如果通过 <code>config.proxy = true</code> 设置了应用部署在反向代理（Nginx）之后，有一些 Getter 的内部处理会发生改变。</strong>(<code>config.proxy</code>配置前置代理模式)</p> <h4 id="ctx-host"><a href="#ctx-host" class="header-anchor">#</a> <code>ctx.host</code></h4> <p>优先读通过 <code>config.hostHeaders</code> 中配置的 <code>header</code> 的值，读不到时再尝试获取 <code>host</code> 这个 <code>header</code> 的值，<strong>如果都获取不到，返回空字符串。</strong></p> <p><code>config.hostHeaders</code> 默认配置为 <code>x-forwarded-host</code>。</p> <h4 id="ctx-protocol"><a href="#ctx-protocol" class="header-anchor">#</a> <code>ctx.protocol</code></h4> <p>通过这个 <code>Getter</code> 获取 <code>protocol</code> 时，首先会判断当前连接是否是加密连接，如果是加密连接，返回 <code>https</code>。</p> <p>如果处于非加密连接时，优先读通过 <code>config.protocolHeaders</code> 中配置的 header 的值来判断是 HTTP 还是 <code>https</code>，<strong>如果读取不到，可以在配置中通过 config.protocol 来设置兜底值，默认为 HTTP。</strong></p> <p><code>config.protocolHeaders</code> 默认配置为 <code>x-forwarded-proto</code>。</p> <h4 id="ctx-ips"><a href="#ctx-ips" class="header-anchor">#</a> <code>ctx.ips</code></h4> <p>通过 <code>ctx.ips</code> 获取请求经过所有的中间设备 <code>IP</code> 地址列表，只有在 <code>config.proxy = true</code> 时，才会通过读取 <code>config.ipHeaders</code> 中配置的 <code>header</code> 的值来获取，<strong>获取不到时为空数组</strong>。</p> <p><code>config.ipHeaders</code> 默认配置为 <code>x-forwarded-for</code>。</p> <h4 id="ctx-ip"><a href="#ctx-ip" class="header-anchor">#</a> <code>ctx.ip</code></h4> <p>通过 <code>ctx.ip</code> 获取请求发起方的 <code>IP</code> 地址，优先从 <code>ctx.ips</code> 中获取，<code>ctx.ips</code> 为空时使用连接上发起方的 <code>IP</code> 地址。</p> <p><strong>注意：<code>ip</code> 和 <code>ips</code> 不同，<code>ip</code> 当 <code>config.proxy = false</code> 时会返回当前连接发起者的 <code>ip</code> 地址，<code>ips</code> 此时会为空数组。</strong></p> <h4 id="cookie"><a href="#cookie" class="header-anchor">#</a> Cookie</h4> <p>HTTP 请求都是无状态的，但是 <code>Web</code> 应用通常都需要知道发起请求的人是谁。为了解决这个问题，HTTP 协议设计了一个特殊的请求头：<code>Cookie</code>。<strong>服务端可以通过响应头（set-cookie）将少量数据响应给客户端</strong>，浏览器会遵循协议将数据保存，并在下次请求同一个服务的时候带上（浏览器也会遵循协议，只在访问符合 <code>Cookie</code> 指定规则的网站时带上对应的 <code>Cookie</code> 来保证安全性）</p> <p>通过 <code>ctx.cookies</code>，可以在 <code>Controller</code> 中便捷、安全的设置和读取 <code>Cookie</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">class</span> <span class="token class-name">CookieController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">// 添加cookies</span>
  <span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    count <span class="token operator">=</span> count <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> <span class="token operator">++</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> count<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 删除cookies</span>
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span>
    <span class="token keyword">const</span> count <span class="token operator">=</span> ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li><p>Cookie 虽然在 HTTP 中只是一个头，但是通过 foo=bar;foo1=bar1; 的格式可以设置多个键值对。</p></li> <li><p>Cookie 在 Web 应用中经常承担了传递客户端身份信息的作用，因此有许多安全相关的配置，不可忽视。</p></li></ul> <h4 id="session"><a href="#session" class="header-anchor">#</a> Session</h4> <p>通过 Cookie，可以给每一个用户设置一个 Session，用来存储用户身份相关的信息，这份信息会加密后存储在 Cookie 中，实现跨请求的用户身份保持。</p> <p><strong>框架内置了 Session 插件，提供了 ctx.session 来访问或者修改当前用户 Session 。</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">fetchPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取 Session 上的内容</span>
    <span class="token keyword">const</span> userId <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token keyword">const</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>post<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 修改 Session 的值</span>
    ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>visited <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>visited <span class="token operator">?</span> <span class="token operator">++</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>visited <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      posts<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>Session 的使用方法非常直观，直接读取它或者修改它就可以了，<strong>如果要删除它，直接将它赋值为 null</strong>：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">SessionController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">deleteSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="参数校验"><a href="#参数校验" class="header-anchor">#</a> 参数校验</h2> <p>在获取到用户请求的参数后，不可避免的要对参数进行一些校验。借助 <code>egg-validate</code> 插件提供便捷的参数校验机制，帮助完成各种复杂的参数校验。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// config/plugin.js</span>
exports<span class="token punctuation">.</span>validate <span class="token operator">=</span> <span class="token punctuation">{</span>
  enable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'egg-validate'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>通过 <code>ctx.validate(rule, [body])</code> 直接对参数进行校验， <strong>如果不传第二个参数会自动校验 <code>ctx.request.body</code></strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 校验参数</span>
    <span class="token comment">// 如果不传第二个参数会自动校验 `ctx.request.body`</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      title<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      content<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'string'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>当校验异常时，会直接抛出一个异常，异常的状态码为 422，errors 字段包含了详细的验证不通过信息。<strong>如果想要自己处理检查的异常，可以通过 try catch 来自行捕获。</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>createRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> success<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="自定义校验规则"><a href="#自定义校验规则" class="header-anchor">#</a> 自定义校验规则</h3> <p>有时候希望自定义一些校验规则，让开发时更便捷，此时可以通过 <code>app.validator.addRule(type, check)</code> 的方式新增自定义规则。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app.js</span>
app<span class="token punctuation">.</span>validator<span class="token punctuation">.</span><span class="token function">addRule</span><span class="token punctuation">(</span><span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">rule<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'must be json string'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>添加完自定义规则之后，就可以在 Controller 中直接使用这条规则来进行参数校验了</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// query.test 字段必须是 json 字符串</span>
    <span class="token keyword">const</span> rule <span class="token operator">=</span> <span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token string">'json'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="调用-service"><a href="#调用-service" class="header-anchor">#</a> 调用 Service</h2> <p>基于分层结构的思想，并不需要在 <code>Controller</code> 中实现太多业务逻辑，所以提供了一个 <code>Service</code> 层进行业务逻辑的封装，这不仅能提高代码的复用性，<strong>同时可以让业务逻辑更好测试</strong>。</p> <p><strong>在 <code>Controller</code> 中可以调用任何一个 <code>Service</code> 上的任何方法，同时 <code>Service</code> 是懒加载的，只有当访问到它的时候框架才会去实例化它。</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> author <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
    <span class="token comment">// Object.assign() 方法用于将所有可枚举属性的值从一个或多个源对象复制到目标对象。它将返回目标对象</span>
    <span class="token keyword">const</span> req <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token punctuation">{</span> author <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调用 service 进行业务处理</span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>post<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> res<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="发送-http-响应"><a href="#发送-http-响应" class="header-anchor">#</a> 发送 HTTP 响应</h2> <p>当业务逻辑完成之后，Controller 的最后一个职责就是将业务逻辑的处理结果通过 HTTP 响应发送给用户。</p> <h2 id="设置-status"><a href="#设置-status" class="header-anchor">#</a> 设置 status</h2> <p>HTTP 设计了非常多的状态码，每一个状态码都代表了一个特定的含义，通过设置正确的状态码，可以让响应更符合语义。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 框架提供了一个便捷的 Setter 来进行状态码的设置</span>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置状态码为 201</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="设置-body"><a href="#设置-body" class="header-anchor">#</a> 设置 body</h2> <p>绝大多数的数据都是通过 body 发送给请求方的，和请求中的 body 一样，在响应中发送的 body，也需要有配套的 Content-Type 告知客户端如何对数据进行解析。</p> <ul><li>作为一个 <code>RESTful</code> 的 <code>API</code> 接口 <code>controller</code>，通常会返回 <code>Content-Type</code> 为 <code>application/json</code> 格式的 <code>body</code>，内容是一个 <code>JSON</code> 字符串。</li> <li>作为一个 <code>html</code> 页面的 <code>controller</code>，通常会返回 <code>Content-Type</code> 为 <code>text/html</code> 格式的 <code>body</code>，内容是 <code>html</code> 代码段。</li></ul> <p><strong>注意：<code>ctx.body</code> 是 <code>ctx.response.body</code> 的简写，和<code>ctx.request.body</code>不一致；</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">ViewController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'egg'</span><span class="token punctuation">,</span>
      category<span class="token operator">:</span> <span class="token string">'framework'</span><span class="token punctuation">,</span>
      language<span class="token operator">:</span> <span class="token string">'Node.js'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 渲染页面</span>
  <span class="token keyword">async</span> <span class="token function">page</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'&lt;html&gt;&lt;h1&gt;Hello&lt;/h1&gt;&lt;/html&gt;'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>由于 Node.js 的流式特性，还有很多场景需要通过 Stream 返回响应，例如返回一个大文件，代理服务器直接返回上游的内容，框架也支持直接将 body 设置成一个 Stream，并会同时处理好这个 Stream 上的错误事件。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">ProxyController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>ctx<span class="token punctuation">}</span><span class="token operator">=</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      streaming<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>header<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// result.res 是一个 stream</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="渲染模板"><a href="#渲染模板" class="header-anchor">#</a> 渲染模板</h2> <p>通常来说，不会去手写 <code>HTML</code> 页面，而是会通过模板引擎进行生成。 框架自身没有集成任何一个模板引擎，但是约定了 <code>View</code> 插件的规范，通过接入的模板引擎，可以直接使用 <code>ctx.render(template)</code> 来渲染模板生成 <code>html</code>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home.tpl'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'egg'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ctx.body = await ctx.renderString('hi, {{ name }}', { name: 'egg' });</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h5 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> JSONP</h5> <p>有时需要给非本域的页面提供接口服务，又由于一些历史原因无法通过 CORS 实现，可以通过 JSONP 来进行响应。</p> <p>由于 JSONP 如果使用不当会导致非常多的安全问题，所以框架中提供了便捷的响应 JSONP 格式数据的方法，<strong>封装了 JSONP XSS 相关的安全防范，并支持进行 CSRF 校验和 referrer 校验。</strong></p> <ul><li>通过 <code>app.jsonp()</code> 提供的中间件来让一个 <code>controller</code> 支持响应 <code>JSONP</code> 格式的数据。在路由中，我们给需要支持 <code>jsonp</code> 的路由加上这个中间件：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> jsonp <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/posts/:id'</span><span class="token punctuation">,</span> jsonp<span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>posts<span class="token punctuation">.</span>show<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/posts'</span><span class="token punctuation">,</span> jsonp<span class="token punctuation">,</span> app<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>posts<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>在 Controller 中，只需要正常编写即可：</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/posts.js</span>
<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'egg'</span><span class="token punctuation">,</span>
      category<span class="token operator">:</span> <span class="token string">'framework'</span><span class="token punctuation">,</span>
      language<span class="token operator">:</span> <span class="token string">'Node.js'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>用户请求对应的 URL 访问到这个 <code>controller</code> 的时候，如果 <code>query</code> 中有 <code>_callback=fn</code> 参数，将会返回 <code>JSONP</code> 格式的数据，否则返回 <code>JSON</code> 格式的数据。</p> <h5 id="jsonp-配置"><a href="#jsonp-配置" class="header-anchor">#</a> JSONP 配置</h5> <p>框架默认通过 <code>query</code> 中的 <code>_callback</code> 参数作为识别是否返回 JSONP 格式数据的依据，并且 <code>_callback</code> 中设置的方法名长度最多只允许 50 个字符。应用可以在 <code>config/config.default.js</code> 全局覆盖默认的配置：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// config/config.default.js</span>
exports<span class="token punctuation">.</span>jsonp <span class="token operator">=</span> <span class="token punctuation">{</span>
  callback<span class="token operator">:</span> <span class="token string">'callback'</span><span class="token punctuation">,</span> <span class="token comment">// 识别 query 中的 `callback` 参数</span>
  limit<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token comment">// 函数名最长为 100 个字符</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p>通过上面的方式配置之后，如果用户请求 <code>/api/posts/1?callback=fn</code>，响应为 <code>JSONP</code> 格式，如果用户请求 <code>/api/posts/1</code>，响应格式为 <code>JSON</code>。</p> <p>同样可以在 <code>app.jsonp()</code> 创建中间件时覆盖默认的配置，以达到不同路由使用不同配置的目的：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller<span class="token punctuation">,</span> jsonp <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/posts/:id'</span><span class="token punctuation">,</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">{</span> callback<span class="token operator">:</span> <span class="token string">'callback'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>posts<span class="token punctuation">.</span>show<span class="token punctuation">)</span><span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/posts'</span><span class="token punctuation">,</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">{</span> callback<span class="token operator">:</span> <span class="token string">'cb'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>posts<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h5 id="跨站防御配置"><a href="#跨站防御配置" class="header-anchor">#</a> 跨站防御配置</h5> <p>默认配置下，响应 JSONP 时不会进行任何跨站攻击的防范，在某些情况下，这是很危险的。初略将 JSONP 接口分为三种类型：</p> <ul><li>查询非敏感数据，例如获取一个论坛的公开文章列表。</li> <li>查询敏感数据，例如获取一个用户的交易记录。</li> <li>提交数据并修改数据库，例如给某一个用户创建一笔订单。</li></ul> <p>如果 JSONP 接口提供下面两类服务，在不做任何跨站防御的情况下，可能泄露用户敏感数据甚至导致用户被钓鱼。<strong>因此框架给 JSONP 默认提供了 CSRF 校验支持和 referrer 校验支持。</strong></p> <h5 id="csrf配置"><a href="#csrf配置" class="header-anchor">#</a> CSRF配置</h5> <p>在 <code>JSONP</code> 配置中，我们只需要打开 <code>csrf: true</code>，即可对 <code>JSONP</code> 接口开启 <code>CSRF</code> 校验。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  jsonp<span class="token operator">:</span> <span class="token punctuation">{</span>
    csrf<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><strong>CSRF 校验依赖于 security 插件提供的基于 Cookie 的 CSRF 校验。</strong></p> <p>在开启 <code>CSRF</code> 校验时，客户端在发起 <code>JSONP</code> 请求时，也要带上 <code>CSRF token</code>，如果发起 <code>JSONP</code> 的请求方所在的页面和我们的服务在同一个主域名之下的话，可以读取到 <code>Cookie</code> 中的 <code>CSRF token</code>（在 <code>CSRF token</code> 缺失时也可以自行设置 <code>CSRF token</code> 到 <code>Cookie</code> 中），并在请求时带上该 token。</p> <h5 id="referrer-校验"><a href="#referrer-校验" class="header-anchor">#</a> referrer 校验</h5> <p>如果在同一个主域之下，可以通过开启 CSRF 的方式来校验 JSONP 请求的来源，<strong>如果想对其他域名的网页提供 JSONP 服务，我们可以通过配置 referrer 白名单的方式来限制 JSONP 的请求方在可控范围之内。</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//config/config.default.js</span>
exports<span class="token punctuation">.</span>jsonp <span class="token operator">=</span> <span class="token punctuation">{</span>
  whiteList<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/test.com\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
  <span class="token comment">// whiteList: '.test.com',</span>
  <span class="token comment">// whiteList: 'sub.test.com',</span>
  <span class="token comment">// whiteList: [ 'sub.test.com', 'sub2.test.com' ],</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><code>whiteList</code> 可以配置为<strong>正则表达式、字符串或者数组</strong>：</p> <ul><li>正则表达式：此时只有请求的 <code>Referrer</code> 匹配该正则时才允许访问 JSONP 接口。在设置正则表达式的时候，<strong>注意开头的 ^ 以及结尾的 /，保证匹配到完整的域名。</strong></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span>jsonp <span class="token operator">=</span> <span class="token punctuation">{</span>
  whiteList<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^https?:\/\/test.com\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// matches referrer:</span>
<span class="token comment">// https://test.com/hello</span>
<span class="token comment">// http://test.com/</span>

</code></pre></div><ul><li>字符串：设置字符串形式的白名单时分为两种，当字符串以 . 开头，例如 <code>.test.com</code> 时，代表 <code>referrer</code> 白名单为 <code>test.com</code> 的所有子域名，包括 <code>test.com</code> 自身。当字符串不以 . 开头，例如 <code>sub.test.com</code>，代表 <code>referrer</code> 白名单为 <code>sub.test.com</code> 这一个域名。（<strong>同时支持 <code>HTTP</code> 和 <code>HTTPS</code></strong>）。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span>jsonp <span class="token operator">=</span> <span class="token punctuation">{</span>
  whiteList<span class="token operator">:</span> <span class="token string">'.test.com'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// matches domain test.com:</span>
<span class="token comment">// https://test.com/hello</span>
<span class="token comment">// http://test.com/</span>

<span class="token comment">// matches subdomain</span>
<span class="token comment">// https://sub.test.com/hello</span>
<span class="token comment">// http://sub.sub.test.com/</span>

exports<span class="token punctuation">.</span>jsonp <span class="token operator">=</span> <span class="token punctuation">{</span>
  whiteList<span class="token operator">:</span> <span class="token string">'sub.test.com'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// only matches domain sub.test.com:</span>
<span class="token comment">// https://sub.test.com/hello</span>
<span class="token comment">// http://sub.test.com/</span>

</code></pre></div><ul><li>数组：当设置的白名单为数组时，代表只要<strong>满足数组中任意一个元素的条件</strong>即可通过 <code>referrer</code> 校验。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
exports<span class="token punctuation">.</span>jsonp <span class="token operator">=</span> <span class="token punctuation">{</span>
  whiteList<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'sub.test.com'</span><span class="token punctuation">,</span> <span class="token string">'sub2.test.com'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// matches domain sub.test.com and sub2.test.com:</span>
<span class="token comment">// https://sub.test.com/hello</span>
<span class="token comment">// http://sub2.test.com/</span>

</code></pre></div><p><strong>当 CSRF 和 referrer 校验同时开启时，请求发起方只需要满足任意一个条件即可通过 JSONP 的安全校验。</strong></p> <h4 id="设置-header"><a href="#设置-header" class="header-anchor">#</a> 设置 Header</h4> <p>通过状态码标识请求成功与否、状态如何，在 <code>body</code> 中设置响应的内容。而通过响应的 <code>Header</code>，还可以设置一些扩展信息。</p> <p>通过 <code>ctx.set(key, value)</code> 方法可以设置一个响应头，<code>ctx.set(headers)</code> 设置多个 <code>Header</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// app/controller/api.js</span>
<span class="token keyword">class</span> <span class="token class-name">ProxyController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>post<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> used <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token comment">// 设置一个响应头</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'show-response-time'</span><span class="token punctuation">,</span> used<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><h4 id="重定向"><a href="#重定向" class="header-anchor">#</a> 重定向</h4> <p>框架通过 <code>security</code> 插件覆盖了 <code>koa</code> 原生的 <code>ctx.redirect</code> 实现，以提供更加安全的重定向。</p> <ul><li><code>ctx.redirect(url)</code> 如果不在配置的白名单域名内，则禁止跳转。</li> <li><code>ctx.unsafeRedirect(url)</code> 不判断域名，直接跳转，一般不建议使用，明确了解可能带来的风险后使用。</li></ul> <p>用户如果使用<code>ctx.redirect</code>方法，需要在应用的配置文件中做如下配置：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// config/config.default.js</span>
exports<span class="token punctuation">.</span>security <span class="token operator">=</span> <span class="token punctuation">{</span>
  domainWhiteList<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'.domain.com'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 安全白名单，以 . 开头</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>若用户没有配置 <code>domainWhiteList</code> 或者 <code>domainWhiteList</code>数组内为空，则默认会对所有跳转请求放行，即等同于<code>ctx.unsafeRedirect(url)</code></strong></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最近更新:</span> <span class="time">1/19/2021, 11:03:12 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/egg-learning/official/router.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        路由（Router）
      </a></span> <span class="next"><a href="/egg-learning/official/service.html">
        服务（Service）
        <i aria-label="icon: right" class="anticon anticon-right"><svg viewBox="64 64 896 896" focusable="false" data-icon="right" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 0 0 302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.9 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 0 0 0-50.4z"></path></svg></i></a></span></p></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/egg-learning/assets/js/app.832bcef2.js" defer></script><script src="/egg-learning/assets/js/2.37616b7d.js" defer></script><script src="/egg-learning/assets/js/9.58d4e40f.js" defer></script>
  </body>
</html>